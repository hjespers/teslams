<!DOCTYPE html><html><head>
<meta name='viewport' content='initial-scale=1.0, user-scalable=no' />
<script language="javascript" type="text/javascript" src="jquery-1.9.1.js"></script>
<script language="javascript" type="text/javascript" src="url.min.js"></script>
<script language="javascript" type="text/javascript" src="lib.js"></script>
<script language="javascript" type="text/javascript" src="jquery-ui-1.10.3.custom.min.js"></script>
<script language="javascript" type="text/javascript" src="jquery-ui-timepicker-addon.js"></script>
<link rel="stylesheet" media="all" type="text/css" href="jquery-ui-timepicker-addon.css" />
<link rel="stylesheet" media="all" type="text/css" href="jquery-ui.css" />
<link rel="stylesheet" media="all" type="text/css" href="shared.css" />
<script type='text/javascript' src='https://maps.googleapis.com/maps/api/js?key=MAGIC_APIKEY&sensor=true'></script>
<script type='text/javascript'>
var myLatlng; var map; var marker; var infoWindow;
var myUrl = "";
function hex(num) { var s = '#0' + num.toString(16) + ''; return s.substring(s.length - 2); }
function getColor(speed) { 
	var wl = speed*2+440; if(wl>640){wl=640;}
	var r=Math.round(35+(wl-510)*3.14); if(r<55){r=55} if(r>255){r=255}
	var b=35+(510-wl)*11;if(b<55){b=55;} if(b>255){b=255}
	var g=(wl<580) ? Math.round(35+(wl-440)*4.4) : Math.round(35+(640-wl)*3.66); if(g<55){g=55} if(g>255){g=255}
	return '#'+hex(r)+hex(g)+hex(b);
}
function cancelUpdates() {
	if (getMore.ID)
		clearInterval(getMore.ID);
}
function getMore() {
	if (myUrl.length == 0)
		return;
	// this gets us an array of arrays - there is always at least one dummy
	// entry that gives us the last timestamp that was considered in this batch
	$.getJSON(myUrl + "/update", { 'speed': +$("#speed").val() })
	.done(function (d, textStatus, jqXHR) {
		console.log("length", d.length, "end", +getMore.endTimestamp, "last", +getMore.lastTimestamp);
		if (d.length == 1 && d[0][2] == 0) { // that's just the fake entry
			getMore.lastTimestamp = +d[0][0];
			console.log("do we need to stop?", "end", +getMore.endTimestamp, "last", +getMore.lastTimestamp);
			if (+getMore.endTimestamp - +getMore.lastTimestamp < 120000)
				cancelUpdates();
			return;
		}
		for (var i = 0; i < d.length; i++) { 
			if (d[i][6] == 0 && d[i][7] == 0)
				continue; // no line to GPS (0,0)
			if (Math.abs(d[i][0] - getMore.lastTimestamp) > 5000) {
				myLatlng = new google.maps.LatLng(d[i][6],d[i][7]);
				getMore.lastTimestamp = +d[i][0];
				continue; // no lines if there is a jump in the time series
			}
			var nextLatlng = new google.maps.LatLng(d[i][6],d[i][7]);
			var points = [myLatlng,nextLatlng];
			var color = getColor(d[i][1]);
			var path = new google.maps.Polyline({path:points,strokeColor:color,strokeWeight:4});
			path.setMap(map);
			myLatlng = nextLatlng;
			getMore.lastTimestamp = d[i][0];
		}
		var cStr = '<div id="content">';
		marker.setPosition(myLatlng);
		var i = d.length - 1; // last spot
		if (d[i][9] == 'D' || d[i][9] == 'R'){cStr+='going '+d[i][1]+' mph'}
		else if (d[i][8] < 0){cStr+='parked and charging ~ '+(-d[i][8])+'kW'}
		else {cStr+='parked'}
		cStr+='<br>odometer '+d[i][2]+'<br>range '+d[i][10]+'</div>';
		infoWindow.setContent(cStr);
	})
	.fail(function(jqXHR, textStatus, errorThrown) { console.log(myUrl + "/update : ajax fail", textStatus, errorThrown); }) 
}
function updateSpeed(event, ui) {
	$("#speed").val(ui.value);
}
function initialize() { 
	getMore.ID = null;
	myUrl = $.url('protocol') + "://" + $.url('auth') + (($.url('auth').length > 0) ? "@" : "") +
		$.url('hostname') + ":" + $.url('port');
	var fromQ = $.url("?from");
	if (fromQ.split("-").length == 5) fromQ += "-00";
	var toQ = $.url("?to");
	var toP = toQ.split("-");
	if (toP.length == 5) { toQ += "-00"; toP[5] = 0 }
	$("#frompicker").val(fromQ);
	$("#topicker").val(toQ);
	$("#energylink").attr("href", myUrl + "/energy?from=" + fromQ + "&to=" + toQ);
	$("#statslink").attr("href", myUrl + "/stats?from=" + fromQ + "&to=" + toQ);
	$("#frompicker").datetimepicker({
		dateFormat: "yy-mm-dd",
		timeFormat: "HH-mm-ss",
		separator: "-",
		defaultValue: fromQ,
		onClose: function(dateText, inst) {
			if (dateText.length > 10 && compareTime(dateText, fromQ) != 0) {
				self.location = myUrl + "/map?from=" + dateText + "&to=" + toQ
			}
		}
	});
	$("#topicker").datetimepicker({
		dateFormat: "yy-mm-dd",
		timeFormat: "HH-mm-ss",
		separator: "-",
		defaultValue: toQ,
		onClose: function(dateText, inst) {
			if (dateText.length > 10 && compareTime(dateText, toQ) != 0) {
				self.location = myUrl + "/map?from=" + fromQ + "&to=" + dateText
			}
		}
	});
	var speedup = $.url("?speed");
	if (speedup == null || speedup == "")
		speedup = 120;
	$("#speedSlider").slider({'animate': 'fast', 'min': 1, 'max': 120, 'value': speedup,
				'slide': updateSpeed});
	$("#speed").val($("#speedSlider").slider("value"));
	myLatlng = new google.maps.LatLng(MAGIC_FIRST_LOC);
	var mapOptions = { center: myLatlng, zoom: 16, mapTypeId: google.maps.MapTypeId.ROADMAP };
	map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
	marker = new google.maps.Marker({ position: myLatlng, map: map, title: 'Tesla Model S'});
	infoWindow = new google.maps.InfoWindow({content: ""});
	infoWindow.open(map, marker);
	getMore.lastTimestamp = 0;
	getMore.endTimestamp = new Date(toP[0], toP[1] - 1, toP[2], toP[3], toP[4], toP[5]);
	getMore();
	getMore.ID = setInterval(getMore, 2000);
}
google.maps.event.addDomListener(window, 'load', initialize);
</script>
</head>
<body>
	<h2>Tesla Tracker <small>(switch to <a id="energylink" href="">Energy Chart</a>, <a id="statslink" href="">Daily Summary Chart</a>)</small></h2>
	<div id="top">
		<div id="dates">
			<label>Start time</label><input id="frompicker" type="text">
			<label>End time</label><input id="topicker" type="text">
			<button onclick="cancelUpdates()">Stop updates</button>
		</div>
		<p><label>Replay Speed (real Time = 1x):</label>
		   <input type="text" id="speed" />
		</p>
		<div id="speedSlider"></div>
	</div>
	<div id='map-canvas'/>
</body> </html>

